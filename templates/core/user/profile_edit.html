{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Profile - GSEZ Profile{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2>Update Your Profile</h2>
        <p class="text-muted">Update your personal information</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{% url 'user_dashboard' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>

{% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
{% endif %}

<form method="post" enctype="multipart/form-data" id="profileForm">
    {% csrf_token %}
    <!-- Hidden input for camera capture data -->
    <input type="hidden" id="camera_capture_data" name="camera_capture_data" value="">
    
    <!-- Basic Information Card -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Basic Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.first_name.id_for_label }}" class="form-label">First Name</label>
                    {{ form.first_name }}
                    {% if form.first_name.errors %}
                        <div class="text-danger">{{ form.first_name.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.middle_name.id_for_label }}" class="form-label">Middle Name</label>
                    {{ form.middle_name }}
                    {% if form.middle_name.errors %}
                        <div class="text-danger">{{ form.middle_name.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.last_name.id_for_label }}" class="form-label">Last Name</label>
                    {{ form.last_name }}
                    {% if form.last_name.errors %}
                        <div class="text-danger">{{ form.last_name.errors }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
                    {{ form.email }}
                    {% if form.email.errors %}
                        <div class="text-danger">{{ form.email.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label" for="username-disabled">Username</label>
                    <input type="text" id="username-disabled" value="{{ user.username }}" class="form-control" aria-describedby="username-help">
                    <small id="username-help" class="form-text text-muted">Username will auto-generate</small>
                    <!-- Hidden field to actually send the username value -->
                    <input type="hidden" id="username-hidden" name="username" value="{{ user.username }}">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label" for="gsezid-disabled">GSEZ ID</label>
                    <input type="text" id="gsezid-disabled" value="{{ user.gsezid }}" class="form-control" disabled title="GSEZ ID cannot be changed" aria-describedby="gsezid-help">
                    <small id="gsezid-help" class="form-text text-muted">GSEZ ID cannot be changed</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Personal Information Card -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Personal Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.nationality.id_for_label }}" class="form-label">Nationality</label>
                    {{ form.nationality }}
                    {% if form.nationality.errors %}
                        <div class="text-danger">{{ form.nationality.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">Date of Birth</label>
                    {{ form.date_of_birth }}
                    {% if form.date_of_birth.errors %}
                        <div class="text-danger">{{ form.date_of_birth.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.profile_photo.id_for_label }}" class="form-label">Profile Photo</label>
                    <div class="mb-2">
                        <button type="button" class="btn btn-sm btn-secondary" id="openCameraBtn">
                            <i class="fas fa-camera"></i> Capture Photo
                        </button>
                    </div>
                    {{ form.profile_photo }}
                    {% if form.profile_photo.errors %}
                        <div class="text-danger">{{ form.profile_photo.errors }}</div>
                    {% endif %}
                    
                    <div class="mt-2">
                    {% if user.profile_photo %}
                            <img src="{{ user.profile_photo.url }}" alt="Current Profile Photo" class="img-thumbnail" id="currentPhoto" style="max-height: 100px;">
                        {% endif %}
                        <img id="previewPhoto" src="#" alt="Preview" class="img-thumbnail mt-2" style="max-height: 100px; display: none;">
                    </div>
                </div>
            </div>
            
            <!-- Camera Modal -->
            <div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="cameraModalLabel"><i class="fas fa-camera"></i> Capture Profile Photo</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-0">
                            <!-- Camera Controls -->
                            <div class="bg-light p-3 mb-0 text-center">
                                <button id="switchCameraBtn" class="btn btn-info me-2">
                                    <i class="fas fa-sync"></i> Switch Camera
                                </button>
                                <span class="badge bg-success">
                                    <i class="fas fa-circle me-1"></i> Camera Active
                                </span>
                            </div>
                            
                            <div class="position-relative">
                                <!-- Video Container with Centered Content and Overlay -->
                                <div class="video-container p-0 text-center bg-dark">
                                    <video id="cameraFeed" style="width: 100%; max-height: 500px; object-fit: cover;" autoplay></video>
                                    <!-- Overlay Guide -->
                                    <div id="faceOverlay" class="position-absolute top-50 start-50 translate-middle" style="border: 2px dashed rgba(255,255,255,0.5); border-radius: 50%; width: 200px; height: 200px; pointer-events: none; display: flex; align-items: center; justify-content: center;">
                                        <div class="text-white bg-dark bg-opacity-50 px-2 py-1 rounded">
                                            <small>Position face here</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Canvas for Captured Photo -->
                                <canvas id="photoCanvas" style="display: none; width: 100%; max-height: 500px; object-fit: cover;" class="bg-dark"></canvas>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="p-3 bg-light d-flex justify-content-center">
                                <button type="button" class="btn btn-lg btn-primary px-4" id="captureBtn">
                                    <i class="fas fa-camera"></i> Take Photo
                                </button>
                                <button type="button" class="btn btn-lg btn-secondary px-4 mx-2" id="retakeBtn" style="display: none;">
                                    <i class="fas fa-redo"></i> Retake
                                </button>
                                <button type="button" class="btn btn-lg btn-success px-4" id="savePhotoBtn" style="display: none;">
                                    <i class="fas fa-check"></i> Use Photo
                                </button>
                            </div>
                            
                            <!-- Instructions -->
                            <div class="p-3 border-top">
                                <h6 class="text-muted"><i class="fas fa-info-circle"></i> Tips for a good photo:</h6>
                                <ul class="text-muted small mb-0">
                                    <li>Ensure your face is well-lit and clearly visible</li>
                                    <li>Position your face inside the circle guide</li>
                                    <li>Look directly at the camera</li>
                                    <li>If you have trouble, try switching cameras or adjusting lighting</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.gsez_card_issue_date.id_for_label }}" class="form-label">GSEZ Card Issue Date</label>
                    {{ form.gsez_card_issue_date }}
                    {% if form.gsez_card_issue_date.errors %}
                        <div class="text-danger">{{ form.gsez_card_issue_date.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.gsez_card_expiry_date.id_for_label }}" class="form-label">GSEZ Card Expiry Date</label>
                    {{ form.gsez_card_expiry_date }}
                    {% if form.gsez_card_expiry_date.errors %}
                        <div class="text-danger">{{ form.gsez_card_expiry_date.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Address Information Card -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Address Information</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="{{ form.current_address.id_for_label }}" class="form-label">Current Address</label>
                {{ form.current_address }}
                {% if form.current_address.errors %}
                    <div class="text-danger">{{ form.current_address.errors }}</div>
                {% endif %}
            </div>
            
            <div class="mb-3 form-check">
                {{ form.is_permanent }}
                <label class="form-check-label" for="{{ form.is_permanent.id_for_label }}">
                    Same as Permanent Address
                </label>
            </div>
            
            <div class="mb-3">
                <label for="{{ form.permanent_address.id_for_label }}" class="form-label">Permanent Address</label>
                {{ form.permanent_address }}
                {% if form.permanent_address.errors %}
                    <div class="text-danger">{{ form.permanent_address.errors }}</div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Emergency Contacts Card -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Emergency Contacts</h5>
            <button type="button" class="btn btn-sm btn-light" id="addEmergencyContact" title="Add contact">
                <i class="fas fa-plus"></i> Add Contact
            </button>
        </div>
        <div class="card-body">
            {% if emergency_contacts %}
                <div class="table-responsive mb-3">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contact Number</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for contact in emergency_contacts %}
                                <tr>
                                    <td>{{ contact.name }}</td>
                                    <td>{{ contact.number }}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-danger remove-contact" data-index="{{ forloop.counter0 }}">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted mb-3">No emergency contacts added yet.</p>
            {% endif %}
            
            <div class="row">
                <div class="col-md-6">
                    <label for="{{ form.emergency_contact_name.id_for_label }}" class="form-label">Contact Name</label>
                    {{ form.emergency_contact_name }}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.emergency_contact_number.id_for_label }}" class="form-label">Contact Number</label>
                    {{ form.emergency_contact_number }}
                </div>
            </div>
            
            <div id="emergencyContactsContainer">
                <!-- Additional emergency contacts will be added here via JavaScript -->
            </div>
            
            <template id="emergencyContactTemplate">
                <div class="emergency-contact-row mb-3 border-top pt-3 mt-3">
                    <div class="row">
                        <div class="col-md-5">
                            <label class="form-label">Contact Name</label>
                            <input type="text" name="emergency_contact_name_extra[]" class="form-control" placeholder="Contact Name">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Contact Number</label>
                            <input type="text" name="emergency_contact_number_extra[]" class="form-control" placeholder="Contact Number">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-sm btn-danger remove-row mt-2" title="Remove contact">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            </template>
            
            <div id="deletedContactsContainer"></div>
        </div>
    </div>
    
    <!-- Family Members Card -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Family Members</h5>
            <button type="button" class="btn btn-sm btn-light" id="addFamilyMember" title="Add family member">
                <i class="fas fa-plus"></i> Add Family Member
            </button>
        </div>
        <div class="card-body">
            {% if family_members %}
                <div class="table-responsive mb-3">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Relation</th>
                                <th>Contact Number</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for member in family_members %}
                                <tr>
                                    <td>{{ member.name }}</td>
                                    <td>{{ member.relation }}</td>
                                    <td>{{ member.number }}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-danger remove-family-member" data-index="{{ forloop.counter0 }}" title="Remove family member">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted mb-3">No family members added yet.</p>
            {% endif %}
            
            <div class="row">
                <div class="col-md-4">
                    <label for="{{ form.family_member_name.id_for_label }}" class="form-label">Member Name</label>
                    {{ form.family_member_name }}
                </div>
                <div class="col-md-4">
                    <label for="{{ form.family_member_relation.id_for_label }}" class="form-label">Relation</label>
                    {{ form.family_member_relation }}
                </div>
                <div class="col-md-4">
                    <label for="{{ form.family_member_number.id_for_label }}" class="form-label">Contact Number</label>
                    {{ form.family_member_number }}
                </div>
            </div>
            
            <div id="familyMembersContainer">
                <!-- Additional family members will be added here via JavaScript -->
            </div>
            
            <template id="familyMemberTemplate">
                <div class="family-member-row mb-3 border-top pt-3 mt-3">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Member Name</label>
                            <input type="text" name="family_member_name_extra[]" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Relation</label>
                            <input type="text" name="family_member_relation_extra[]" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Contact Number</label>
                            <input type="text" name="family_member_number_extra[]" class="form-control">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-sm btn-danger remove-row mt-2" title="Remove row">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            </template>
            
            <div id="deletedFamilyMembersContainer"></div>
        </div>
    </div>
    
    <!-- Employment Information Card -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Current Employment</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.current_employer.id_for_label }}" class="form-label">Current Employer</label>
                    {{ form.current_employer }}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.current_employer_company.id_for_label }}" class="form-label">Company</label>
                    {{ form.current_employer_company }}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.current_employer_join_date.id_for_label }}" class="form-label">Join Date</label>
                    {{ form.current_employer_join_date }}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.current_employer_emp_code.id_for_label }}" class="form-label">Employee Code</label>
                    {{ form.current_employer_emp_code }}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.current_employer_designation.id_for_label }}" class="form-label">Designation</label>
                    {{ form.current_employer_designation }}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.current_employer_department.id_for_label }}" class="form-label">Department</label>
                    {{ form.current_employer_department }}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-8 mb-3">
                    <label for="{{ form.current_employer_remarks.id_for_label }}" class="form-label">Remarks</label>
                    {{ form.current_employer_remarks }}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.current_employer_rating.id_for_label }}" class="form-label">Rating (1-5)</label>
                    {{ form.current_employer_rating }}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Previous Employment Card -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Previous Employment</h5>
            <button type="button" class="btn btn-sm btn-light" id="addPreviousEmployer" title="Add previous employer">
                <i class="fas fa-plus"></i> Add Previous Employer
            </button>
        </div>
        <div class="card-body">
            {% if previous_employers %}
                <div class="table-responsive mb-3">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Join Date</th>
                                <th>Leave Date</th>
                                <th>Rating</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for employer in previous_employers %}
                                <tr>
                                    <td>{{ employer.company }}</td>
                                    <td>{{ employer.join_date }}</td>
                                    <td>{{ employer.leave_date }}</td>
                                    <td>{{ employer.rating }}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-danger remove-employer" data-index="{{ forloop.counter0 }}" title="Remove employer">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted mb-3">No previous employers added yet.</p>
            {% endif %}
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.previous_employer_name.id_for_label }}" class="form-label">Company Name</label>
                    {{ form.previous_employer_name }}
                </div>
                <div class="col-md-3 mb-3">
                    <label for="{{ form.previous_employer_join_date.id_for_label }}" class="form-label">Join Date</label>
                    {{ form.previous_employer_join_date }}
                </div>
                <div class="col-md-3 mb-3">
                    <label for="{{ form.previous_employer_leave_date.id_for_label }}" class="form-label">Leave Date</label>
                    {{ form.previous_employer_leave_date }}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-8 mb-3">
                    <label for="{{ form.previous_employer_remarks.id_for_label }}" class="form-label">Remarks</label>
                    {{ form.previous_employer_remarks }}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.previous_employer_rating.id_for_label }}" class="form-label">Rating (1-5)</label>
                    {{ form.previous_employer_rating }}
                </div>
            </div>
            
            <div id="previousEmployersContainer">
                <!-- Additional previous employers will be added here via JavaScript -->
            </div>
            
            <template id="previousEmployerTemplate">
                <div class="previous-employer-row mb-3 border-top pt-3 mt-3">
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Company Name</label>
                            <input type="text" name="previous_employer_name_extra[]" class="form-control">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Join Date</label>
                            <input type="date" name="previous_employer_join_date_extra[]" class="form-control">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Leave Date</label>
                            <input type="date" name="previous_employer_leave_date_extra[]" class="form-control">
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Remarks</label>
                            <textarea name="previous_employer_remarks_extra[]" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Rating (1-5)</label>
                            <input type="number" name="previous_employer_rating_extra[]" min="1" max="5" class="form-control">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 text-end">
                            <button type="button" class="btn btn-sm btn-danger remove-row" title="Remove previous employer">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            </template>
            
            <div id="deletedEmployersContainer"></div>
        </div>
    </div>
    
    <!-- Qualifications Card -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Qualifications</h5>
            <button type="button" class="btn btn-sm btn-light" id="addQualification" title="Add qualification">
                <i class="fas fa-plus"></i> Add Qualification
            </button>
        </div>
        <div class="card-body">
            {% if qualifications %}
                <div class="table-responsive mb-3">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Qualification</th>
                                <th>Institution</th>
                                <th>Year</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for qual in qualifications %}
                                <tr>
                                    <td>{{ qual.qualification }}</td>
                                    <td>{{ qual.institution }}</td>
                                    <td>{{ qual.year }}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-danger remove-qualification" data-index="{{ forloop.counter0 }}" title="Remove qualification">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted mb-3">No qualifications added yet.</p>
            {% endif %}
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.qualification.id_for_label }}" class="form-label">Qualification</label>
                    {{ form.qualification }}
                </div>
                <div class="col-md-5 mb-3">
                    <label for="{{ form.institution.id_for_label }}" class="form-label">Institution</label>
                    {{ form.institution }}
                </div>
                <div class="col-md-3 mb-3">
                    <label for="{{ form.year_of_passing.id_for_label }}" class="form-label">Year of Passing</label>
                    {{ form.year_of_passing }}
                </div>
            </div>
            
            <div id="qualificationsContainer">
                <!-- Additional qualifications will be added here via JavaScript -->
            </div>
            
            <template id="qualificationTemplate">
                <div class="qualification-row mb-3 border-top pt-3 mt-3">
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Qualification</label>
                            <input type="text" name="qualification_extra[]" class="form-control">
                        </div>
                        <div class="col-md-5 mb-2">
                            <label class="form-label">Institution</label>
                            <input type="text" name="institution_extra[]" class="form-control">
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label">Year of Passing</label>
                            <input type="number" name="year_of_passing_extra[]" class="form-control">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 text-end">
                            <button type="button" class="btn btn-sm btn-danger remove-row" title="Remove qualification">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            </template>
            
            <div id="deletedQualificationsContainer"></div>
        </div>
    </div>
    
    <!-- Submit Button -->
    <div class="text-center mb-5">
        <button type="submit" class="btn btn-primary btn-lg px-5">
            <i class="fas fa-save me-2"></i> Save Profile
        </button>
    </div>
</form>

<!-- JavaScript for Dynamic Forms -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-fill username based on first name, last name, and GSEZ ID
    const firstNameField = document.getElementById('{{ form.first_name.id_for_label }}');
    const lastNameField = document.getElementById('{{ form.last_name.id_for_label }}');
    const gsezIdField = document.getElementById('gsezid-disabled');
    const usernameField = document.getElementById('username-disabled');
    
    function updateUsername() {
        const gsezId = gsezIdField.value.trim();
        
        // Only use GSEZ ID as username
        if (gsezId) {
            usernameField.value = gsezId;
        } else {
            usernameField.value = '';
        }
        
        // Also update hidden username field
        const hiddenUsernameField = document.getElementById('username-hidden');
        if (hiddenUsernameField) {
            hiddenUsernameField.value = usernameField.value;
        }
    }
    
    firstNameField.addEventListener('input', updateUsername);
    lastNameField.addEventListener('input', updateUsername);
    
    // Emergency Contacts
    const addEmergencyContactBtn = document.getElementById('addEmergencyContact');
    const emergencyContactTemplate = document.getElementById('emergencyContactTemplate');
    const emergencyContactsContainer = document.getElementById('emergencyContactsContainer');
    
    if (addEmergencyContactBtn && emergencyContactTemplate && emergencyContactsContainer) {
        addEmergencyContactBtn.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent form submission
            const clone = document.importNode(emergencyContactTemplate.content, true);
            const removeBtn = clone.querySelector('.remove-row');
            if (removeBtn) {
                removeBtn.addEventListener('click', function(e) {
                    e.preventDefault(); // Prevent form submission
                    this.closest('.emergency-contact-row').remove();
                });
            }
            emergencyContactsContainer.appendChild(clone);
        });
    }
    
    // Family Members
    const addFamilyMemberBtn = document.getElementById('addFamilyMember');
    const familyMemberTemplate = document.getElementById('familyMemberTemplate');
    const familyMembersContainer = document.getElementById('familyMembersContainer');
    
    if (addFamilyMemberBtn && familyMemberTemplate && familyMembersContainer) {
        addFamilyMemberBtn.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent form submission
            const clone = document.importNode(familyMemberTemplate.content, true);
            const removeBtn = clone.querySelector('.remove-row');
            if (removeBtn) {
                removeBtn.addEventListener('click', function(e) {
                    e.preventDefault(); // Prevent form submission
                    this.closest('.family-member-row').remove();
                });
            }
            familyMembersContainer.appendChild(clone);
        });
    }
    
    // Previous Employers
    const addPreviousEmployerBtn = document.getElementById('addPreviousEmployer');
    const previousEmployerTemplate = document.getElementById('previousEmployerTemplate');
    const previousEmployersContainer = document.getElementById('previousEmployersContainer');
    
    if (addPreviousEmployerBtn && previousEmployerTemplate && previousEmployersContainer) {
        addPreviousEmployerBtn.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent form submission
            const clone = document.importNode(previousEmployerTemplate.content, true);
            const removeBtn = clone.querySelector('.remove-row');
            if (removeBtn) {
                removeBtn.addEventListener('click', function(e) {
                    e.preventDefault(); // Prevent form submission
                    this.closest('.previous-employer-row').remove();
                });
            }
            previousEmployersContainer.appendChild(clone);
        });
    }
    
    // Qualifications
    const addQualificationBtn = document.getElementById('addQualification');
    const qualificationTemplate = document.getElementById('qualificationTemplate');
    const qualificationsContainer = document.getElementById('qualificationsContainer');
    
    if (addQualificationBtn && qualificationTemplate && qualificationsContainer) {
        addQualificationBtn.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent form submission
            const clone = document.importNode(qualificationTemplate.content, true);
            const removeBtn = clone.querySelector('.remove-row');
            if (removeBtn) {
                removeBtn.addEventListener('click', function(e) {
                    e.preventDefault(); // Prevent form submission
                    this.closest('.qualification-row').remove();
                });
            }
            qualificationsContainer.appendChild(clone);
        });
    }
    
    // Handle remove buttons for existing items
    document.querySelectorAll('.remove-contact').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent form submission
            const row = this.closest('tr');
            row.style.display = 'none';
            const index = this.getAttribute('data-index');
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'deleted_contacts[]';
            input.value = index;
            const container = document.getElementById('deletedContactsContainer');
            if (container) {
                container.appendChild(input);
            }
        });
    });
    
    document.querySelectorAll('.remove-family-member').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent form submission
            const row = this.closest('tr');
            row.style.display = 'none';
            const index = this.getAttribute('data-index');
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'deleted_family_members[]';
            input.value = index;
            const container = document.getElementById('deletedFamilyMembersContainer');
            if (container) {
                container.appendChild(input);
            }
        });
    });
    
    document.querySelectorAll('.remove-employer').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent form submission
            const row = this.closest('tr');
            row.style.display = 'none';
            const index = this.getAttribute('data-index');
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'deleted_employers[]';
            input.value = index;
            const container = document.getElementById('deletedEmployersContainer');
            if (container) {
                container.appendChild(input);
            }
        });
    });
    
    document.querySelectorAll('.remove-qualification').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent form submission
            const row = this.closest('tr');
            row.style.display = 'none';
            const index = this.getAttribute('data-index');
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'deleted_qualifications[]';
            input.value = index;
            const container = document.getElementById('deletedQualificationsContainer');
            if (container) {
                container.appendChild(input);
            }
        });
    });
});
</script>
{% endblock %} 